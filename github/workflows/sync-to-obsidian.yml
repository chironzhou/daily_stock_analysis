name: æ¯æ—¥è‚¡ç¥¨åˆ†æ - åŒæ­¥åˆ° Obsidian

on:
  schedule:
    # æ—©ä¸Š 9:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰= UTC 1:00
    - cron: '0 1 * * 1-5'
    # ä¸Šåˆ 11:00 = UTC 3:00
    - cron: '0 3 * * 1-5'
    # ä¸‹åˆ 13:00 = UTC 5:00
    - cron: '0 5 * * 1-5'
    # ä¸‹åˆ 15:00 = UTC 7:00
    - cron: '0 7 * * 1-5'
    # æ™šä¸Š 20:00 = UTC 12:00
    - cron: '0 12 * * 1-5'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  analyze-and-sync:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt

      # 4. è¿è¡Œåˆ†æ
      - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
        run: |
          python main.py --stocks $STOCK_LIST --no-notify

      # 5. è½¬æ¢ä¸º Obsidian æ ¼å¼
      - name: è½¬æ¢ä¸º Obsidian æ ¼å¼
        run: |
          mkdir -p obsidian-output/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜
          
          for report in reports/report_*.md; do
            if [ -f "$report" ]; then
              filename=$(basename "$report" .md)
              date=$(echo $filename | sed 's/report_//')
              formatted_date="${date:0:4}-${date:4:2}-${date:6:2}"
              
              echo "---" > "obsidian-output/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/${formatted_date}.md"
              echo "date: ${formatted_date}" >> "obsidian-output/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/${formatted_date}.md"
              echo "type: æ¯æ—¥å¤ç›˜" >> "obsidian-output/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/${formatted_date}.md"
              echo "---" >> "obsidian-output/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/${formatted_date}.md"
              echo "" >> "obsidian-output/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/${formatted_date}.md"
              cat "$report" >> "obsidian-output/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/${formatted_date}.md"
            fi
          done

      # 6. åŒæ­¥åˆ° Obsidian Vault
      - name: åŒæ­¥åˆ° Obsidian Vault
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ secrets.TARGET_REPO }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git clone https://x-access-token:${GH_PAT}@github.com/${TARGET_REPO}.git target-vault
          cp -r obsidian-output/è‚¡ç¥¨åˆ†æ/* target-vault/è‚¡ç¥¨åˆ†æ/
          
          cd target-vault
          git add .
          git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è‚¡ç¥¨åˆ†æ $(date '+%Y-%m-%d %H:%M')"
          git push origin main
