name: åŒæ­¥åˆ†æç»“æœåˆ° Obsidian Vault

on:
  # åœ¨ä¸»å·¥ä½œæµå®Œæˆåè¿è¡Œ
  workflow_run:
    workflows: ["æ¯æ—¥è‚¡ç¥¨åˆ†æ"]
    types:
      - completed
  workflow_dispatch:  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync-to-vault:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºåˆ†æä»“åº“ï¼ˆè·å–ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
      - name: æ£€å‡ºåˆ†æç»“æœ
        uses: actions/checkout@v4

      # 2. é…ç½® git
      - name: é…ç½® Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 3. å…‹éš†ç›®æ ‡ Obsidian vault ä»“åº“
      - name: å…‹éš† Obsidian Vault
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ secrets.TARGET_REPO }}
        run: |
          git clone https://x-access-token:${GH_PAT}@github.com/${TARGET_REPO}.git target-vault

      # 4. å¤åˆ¶ç”Ÿæˆçš„åˆ†ææ–‡ä»¶åˆ° vault
      - name: å¤åˆ¶åˆ†ææ–‡ä»¶
        run: |
          # å¦‚æœ output ç›®å½•å­˜åœ¨ï¼Œå¤åˆ¶æ–‡ä»¶
          if [ -d "output" ]; then
            mkdir -p target-vault/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜
            mkdir -p target-vault/è‚¡ç¥¨åˆ†æ/è‚¡ç¥¨æ± 
            
            # å¤åˆ¶æ¯æ—¥å¤ç›˜
            cp output/daily-*.md target-vault/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/ 2>/dev/null || true
            
            # å¤åˆ¶ä¸ªè‚¡åˆ†æ
            cp output/stock-*.md target-vault/è‚¡ç¥¨åˆ†æ/è‚¡ç¥¨æ± / 2>/dev/null || true
            
            # å¤åˆ¶å¤§ç›˜åˆ†æ
            cp output/market-*.md target-vault/è‚¡ç¥¨åˆ†æ/ 2>/dev/null || true
          fi

      # 5. æäº¤å¹¶æ¨é€åˆ° vault ä»“åº“
      - name: æäº¤åˆ° Vault
        run: |
          cd target-vault
          git add .
          git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è‚¡ç¥¨åˆ†æ $(date '+%Y-%m-%d %H:%M:%S')" && git push origin main
