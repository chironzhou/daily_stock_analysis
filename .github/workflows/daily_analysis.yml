name: æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  schedule:
    - cron: '0 1 * * 1-5'   # æ—©ä¸Š 9:00
    - cron: '0 3 * * 1-5'   # ä¸Šåˆ 11:00
    - cron: '0 5 * * 1-5'   # ä¸‹åˆ 13:00
    - cron: '0 7 * * 1-5'   # ä¸‹åˆ 15:00
    - cron: '0 12 * * 1-5'  # æ™šä¸Š 20:00
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  analyze-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt

      - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
        run: |
          python main.py --stocks $STOCK_LIST --no-notify

      - name: åŒæ­¥åˆ° Obsidian Vault
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ secrets.TARGET_REPO }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # å…‹éš† vault ä»“åº“
          git clone https://x-access-token:${GH_PAT}@github.com/${TARGET_REPO}.git vault
          
          # åˆ›å»ºç›®å½•å¹¶å¤åˆ¶æŠ¥å‘Š
          mkdir -p vault/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜
          cp reports/report_*.md vault/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/ 2>/dev/null || true
          cp reports/market_review_*.md vault/è‚¡ç¥¨åˆ†æ/ 2>/dev/null || true
          
          # æäº¤å¹¶æ¨é€
          cd vault
          git add .
          git diff --staged --quiet || git commit -m "ğŸ¤– æ›´æ–°åˆ†æ $(date '+%Y-%m-%d %H:%M')" && git push origin main
