name: æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  schedule:
    - cron: '0 1 * * 1-5'   # æ—©ä¸Š 9:00
    - cron: '0 3 * * 1-5'   # ä¸Šåˆ 11:00
    - cron: '0 5 * * 1-5'   # ä¸‹åˆ 13:00
    - cron: '0 7 * * 1-5'   # ä¸‹åˆ 15:00
    - cron: '0 12 * * 1-5'  # æ™šä¸Š 20:00
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  analyze-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt

      - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
        run: |
          python main.py --stocks $STOCK_LIST --no-notify

      - name: åŒæ­¥åˆ° Obsidian Vault
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          TARGET_REPO: ${{ secrets.TARGET_REPO }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # è°ƒè¯•ï¼šåˆ—å‡º reports ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶
          echo "=== Reports ç›®å½•å†…å®¹ ==="
          ls -la reports/
          echo "========================"
          
          # å…‹éš† vault ä»“åº“
          git clone https://x-access-token:${GH_PAT}@github.com/${TARGET_REPO}.git vault
          
          # åˆ›å»ºç›®å½•
          mkdir -p vault/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜
          
          # å¤åˆ¶æ‰€æœ‰ md æ–‡ä»¶ï¼ˆä¸ç®¡æ–‡ä»¶åæ˜¯ä»€ä¹ˆï¼‰
          if [ -d "reports" ]; then
            for file in reports/*.md; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "å¤åˆ¶æ–‡ä»¶: $filename"
                
                # åˆ¤æ–­æ˜¯æ¯æ—¥å¤ç›˜è¿˜æ˜¯å¤§ç›˜å¤ç›˜
                if [[ $filename == *"market"* ]]; then
                  cp "$file" vault/è‚¡ç¥¨åˆ†æ/
                else
                  # æ·»åŠ  frontmatter
                  date=$(date +%Y-%m-%d)
                  {
                    echo "---"
                    echo "date: $date"
                    echo "type: æ¯æ—¥å¤ç›˜"
                    echo "---"
                    echo ""
                    cat "$file"
                  } > "vault/è‚¡ç¥¨åˆ†æ/æ¯æ—¥å¤ç›˜/$date.md"
                fi
              fi
            done
          fi
          
          # æäº¤å¹¶æ¨é€
          cd vault
          git add .
          git diff --staged --quiet || git commit -m "ğŸ¤– æ›´æ–°åˆ†æ $(date '+%Y-%m-%d %H:%M')" && git push origin main

